<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>4buf</title>
  
  
  <link href="http://4buf.com/atom.xml" rel="self"/>
  
  <link href="http://4buf.com/"/>
  <updated>2021-03-29T03:17:10.759Z</updated>
  <id>http://4buf.com/</id>
  
  <author>
    <name>4buf</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Jos Process</title>
    <link href="http://4buf.com/2021/03/19/jos-process/"/>
    <id>http://4buf.com/2021/03/19/jos-process/</id>
    <published>2021-03-18T16:00:00.000Z</published>
    <updated>2021-03-29T03:17:10.759Z</updated>
    
    <content type="html"><![CDATA[<p>TODO</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;TODO&lt;/p&gt;
</summary>
      
    
    
    
    <category term="jos" scheme="http://4buf.com/categories/jos/"/>
    
    
  </entry>
  
  <entry>
    <title>Jos Memory</title>
    <link href="http://4buf.com/2021/03/18/jos-memory/"/>
    <id>http://4buf.com/2021/03/18/jos-memory/</id>
    <published>2021-03-17T16:00:00.000Z</published>
    <updated>2021-03-29T03:17:09.126Z</updated>
    
    <content type="html"><![CDATA[<p>TODO</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;TODO&lt;/p&gt;
</summary>
      
    
    
    
    <category term="jos" scheme="http://4buf.com/categories/jos/"/>
    
    
  </entry>
  
  <entry>
    <title>Jos Bootloader</title>
    <link href="http://4buf.com/2021/03/17/jos-bootloader/"/>
    <id>http://4buf.com/2021/03/17/jos-bootloader/</id>
    <published>2021-03-16T16:00:00.000Z</published>
    <updated>2021-03-30T11:06:27.424Z</updated>
    
    <content type="html"><![CDATA[<p>脚本分为 <code>boot.S</code> 和 <code>loader.c</code>，最终编译合并为 bootloader，它的工作职责很简单：</p><ul><li>boot 负责初始化</li><li>loader 负责把 kernel 从磁盘上加载到内存</li></ul><p><code>boot.S</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">.globl start</span><br><span class="line">start:</span><br><span class="line">    .code16</span><br><span class="line">    cli</span><br><span class="line">    cld</span><br><span class="line">    </span><br><span class="line">    xorw %ax,%ax</span><br><span class="line">    movw %ax,%ds</span><br><span class="line">    movw %ax,%es</span><br><span class="line">    movw %ax,%gs</span><br><span class="line">    movw %ax,%fs</span><br><span class="line">    movw %ax,%ss</span><br><span class="line"></span><br><span class="line">seta20.1:</span><br><span class="line">    inb     $0x64,%al</span><br><span class="line">    testb   $0x2,%al</span><br><span class="line">    jnz     seta20.1</span><br><span class="line">    </span><br><span class="line">    movb    $0xd1,%al</span><br><span class="line">    outb    %al,$0x64</span><br><span class="line"></span><br><span class="line">seta20.2:</span><br><span class="line">    inb     $0x64,%al</span><br><span class="line">    testb   $0x2,%al</span><br><span class="line">    jnz     seta20.2</span><br><span class="line">    </span><br><span class="line">    movb    $0xdf,%al</span><br><span class="line">    outb    %al,$0x60</span><br><span class="line">    </span><br><span class="line">    lgdt    gdtdesc</span><br><span class="line">    movl    %cr0, %eax</span><br><span class="line">    orl     $0x1, %eax</span><br><span class="line">    movl    %eax, %cr0</span><br><span class="line">    </span><br><span class="line">    ljmp    $0x8, $protcseg</span><br><span class="line">    </span><br><span class="line">    .code32</span><br><span class="line">protcseg:</span><br><span class="line">    movw    $0x10, %ax</span><br><span class="line">    movw    %ax, %ds</span><br><span class="line">    movw    %ax, %es</span><br><span class="line">    movw    %ax, %fs</span><br><span class="line">    movw    %ax, %gs</span><br><span class="line">    movw    %ax, %ss</span><br><span class="line">    </span><br><span class="line">    movl    $start, %esp</span><br><span class="line">    call    loader</span><br><span class="line"></span><br><span class="line">spin:</span><br><span class="line">    jmpspin</span><br><span class="line"></span><br><span class="line">gdt:</span><br><span class="line">    # null seg</span><br><span class="line">    .long 0x0, 0x0</span><br><span class="line">    </span><br><span class="line">    # code seg</span><br><span class="line">    .word 0xffff        # Segment Limit 15:00</span><br><span class="line">    .word 0x0           # Base Address 15:00</span><br><span class="line">    .byte 0x0           # Base 23:16</span><br><span class="line">    .byte 0b10011010    # P&#x3D;1, DPL&#x3D;0, S&#x3D;1, Type&#x3D;1010&#x3D;Execute&#x2F;Read</span><br><span class="line">    .byte 0b11001111    # G&#x3D;1, D&#x2F;B&#x3D;1, L&#x3D;0, AVL&#x3D;0, Seg.Limit.19:16</span><br><span class="line">    .byte 0x0           # Base 31:24</span><br><span class="line">    </span><br><span class="line">    # data seg</span><br><span class="line">    .word 0xffff        # Segment Limit 15:00</span><br><span class="line">    .word 0x0           # Base Address 15:00</span><br><span class="line">    .byte 0x0           # Base 23:16</span><br><span class="line">    .byte 0b10010010    # P&#x3D;1, DPL&#x3D;0, S&#x3D;1, Type&#x3D;0010&#x3D;Read&#x2F;Write</span><br><span class="line">    .byte 0b11001111    # G&#x3D;1, D&#x2F;B&#x3D;1, L&#x3D;0, AVL&#x3D;0, Seg.Limit.19:16</span><br><span class="line">    .byte 0x0           # Base 31:24</span><br><span class="line"></span><br><span class="line">gdtdesc:</span><br><span class="line">    .word   0x17</span><br><span class="line">    .long   gdt</span><br></pre></td></tr></table></figure><p>boot 有几步：</p><ol><li>清空数据段寄存器（bios 引导完 cs:ip = 0x7c00，所以 cs 不需要设置）</li><li>开启 A20 line</li><li>加载 GDT</li><li>开启 CR0.PE</li><li>设置段选择子并跳到 loader.c 中的入口</li></ol><p><strong>1. 清空段寄存器</strong></p><p>实模式下寻址方式为 <code>段基址 &lt;&lt; 4 + 偏移量</code>，即 16-bit 凑出 20-bit（涉及历史原因），所以清空段寄存器使得 offset = PA。</p><p><strong>2. 开启 A20 line</strong></p><p>A20 参考（其实就是键盘控制器和 A20 引脚的与门）：</p><ul><li><a href="http://www.independent-software.com/operating-system-development-enabling-a20-line.html">ENABLING THE A20 LINE</a></li><li><a href="https://www.win.tue.nl/~aeb/linux/kbd/A20.html">A20 - a pain from the past</a></li><li><a href="https://bochs.sourceforge.io/techspec/PORTS.LST">XT, AT and PS/2 I/O port addresses</a></li></ul><p><strong>3. 加载 GDT</strong></p><p>不同于 8086 实模式，32-bit 保护模式下 offset 已经有 32 位了，理论上我们可以这么玩：Offset = Logical-Address = Linear-Address = Physical-Address，但是 x86 的架构导致我们并不能限制段寄存器参与寻址，既然得带着它玩，那如果不开启分页单纯分段寻址，让段寄存器去切 4G 内存显然也不合理，毕竟它还是 16-bit 也切不到那么高的地方，这个时候就得想办法把 Segment-Base-Address 长度扩一点，那明显只有放内存里了，于时：</p><ul><li>段基址在 GDT 中放到内存，GDT 是一张表，每个段寄存器可以指定使用其中一项，段寄存器中类似索引功能的值就被称为 <code>Segment Selector</code>，而 GDT 中的每一项称为 <code>Segment Descriptor</code></li><li>CPU 也需要知道 GDT 在哪/有多大，这个值被放到了 GDTR 寄存器</li></ul><p>GDT 的格式参考 Intel 手册 <code>325384-sdm-vol-3abcd.pdf</code> 如下：</p><p><img src="/images/jos-bootloader/segment_descriptor.png"></p><p><code>boot.S</code> 中将 6.828 原先的 SEG_NULL/SEG 方法替换成了手写，请注意 x86 默认是 Little-Endian 小端序，想象一下代码是从上到下被放到内存从低到高（<code>.word</code>/<code>.byte</code> 左高位右低位），再对比 Segment Descriptor 从右到左可以很直观的看到具体的定义。</p><p>可以看到我们虽然使用了分段，但实际上为了将来的分页，这里的分段特性是期望尽可能 “抹除” 的，<strong>毕竟分段是 x86 的特性，而分页才是现代 OS 的共性</strong>。默认约定 GDT 第一个 Descriptor 为空段，所以要让分段透明，至少需要 null/code/data 三个段，而为了简单起见（毕竟进了 kernel 的逻辑就开启分页了，也就为了 <code>loader.c</code> 执行这么一会），所以代码和数据段都映射到了整段内存。</p><p>定义好 GDT 之后需要通过 <code>lgdt</code> 设置 GDTR 寄存器的值（也就是代码中 <code>gdtdesc</code> 的值），需要注意的是 <code>limit = 0x17 = (segment-descriptor = 64-bit = 8-byte) * 3 - 1</code>（减 1 是约定）：</p><p><img src="/images/jos-bootloader/gdtr.png"></p><p>而在设置段寄存器时，Segment Selector 格式如下：</p><p><img src="/images/jos-bootloader/segment_selector.png"></p><p>可以看到代码段选择子为 <code>0x8</code>，其余为 <code>0x10</code>，段寄存器的赋值方式为：</p><ul><li> Direct load instructions such as the MOV, POP, LDS, LES, LSS, LGS, and LFS instructions. These instructions explicitly reference the segment registers.</li><li> Implied load instructions such as the far pointer versions of the CALL, JMP, and RET instructions, the SYSENTER and SYSEXIT instructions, and the IRET, INT n, INTO, INT3, and INT1 instructions. <strong>These instructions change the contents of the CS register</strong> (and sometimes other segment registers) as an incidental part of their operation.</li></ul><p>// TODO</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;脚本分为 &lt;code&gt;boot.S&lt;/code&gt; 和 &lt;code&gt;loader.c&lt;/code&gt;，最终编译合并为 bootloader，它的工作职责很简单：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;boot 负责初始化&lt;/li&gt;
&lt;li&gt;loader 负责把 kernel 从磁盘上加载到</summary>
      
    
    
    
    <category term="jos" scheme="http://4buf.com/categories/jos/"/>
    
    
  </entry>
  
</feed>
